<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VIRTI JAIN PATHSHALA | Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #198754;
      --primary-dark: #146c43;
      --secondary-color: #ffc107;
      --accent-color: #0d6efd;
      --light-bg: #f8fafc;
      --card-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      --hover-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      min-height: 100vh;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: #fff;
      position: fixed;
      left: 0;
      top: 0;
      width: 280px;
      z-index: 1000;
      transition: all 0.3s ease;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }

    .sidebar-header {
      padding: 2rem 1.5rem;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-header h3 {
      font-weight: 700;
      letter-spacing: 2px;
      margin: 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .sidebar-header p {
      margin: 0.5rem 0 0 0;
      opacity: 0.8;
      font-size: 0.9rem;
    }

    .nav-menu {
      padding: 1.5rem 0;
    }

    .nav-item {
      margin: 0.25rem 1rem;
    }

    .nav-link {
      color: #fff;
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      text-decoration: none;
      font-weight: 500;
    }

    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--secondary-color);
      transform: translateX(5px);
    }

    .nav-link.active {
      background: rgba(255, 255, 255, 0.2);
      color: var(--secondary-color);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .nav-link i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
    }

    /* Main Content */
    .main-content {
      margin-left: 280px;
      min-height: 100vh;
      transition: all 0.3s ease;
    }

    /* Top Navigation */
    .top-nav {
      background: #fff;
      padding: 1rem 2rem;
      box-shadow: var(--card-shadow);
      position: sticky;
      top: 0;
      z-index: 999;
    }

    .top-nav-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .welcome-text {
      font-size: 1.25rem;
      font-weight: 600;
      color: #333;
    }

    .admin-name {
      color: var(--primary-color);
      font-weight: 700;
    }

    .logout-btn {
      background: linear-gradient(45deg, #dc3545, #c82333);
      border: none;
      color: white;
      padding: 0.5rem 1.5rem;
      border-radius: 25px;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
      background: linear-gradient(45deg, #c82333, #bd2130);
    }

    /* Dashboard Content */
    .dashboard-content {
      padding: 2rem;
    }

    /* Dashboard Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #fff;
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      border-left: 4px solid var(--primary-color);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--hover-shadow);
    }

    .stat-card.blue { border-left-color: var(--accent-color); }
    .stat-card.orange { border-left-color: #fd7e14; }
    .stat-card.purple { border-left-color: #6f42c1; }

    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      opacity: 0.8;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: #666;
      font-weight: 500;
    }

    /* Content Sections */
    .content-section {
      background: #fff;
      border-radius: 15px;
      box-shadow: var(--card-shadow);
      margin-bottom: 2rem;
      overflow: hidden;
    }

    .section-header {
      background: linear-gradient(135deg, var(--accent-color), #0056b3);
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-header h4 {
      margin: 0;
      font-weight: 600;
    }

    .section-body {
      padding: 2rem;
    }

    /* Table Styles */
    .table-container {
      overflow-x: auto;
      border-radius: 10px;
    }

    .custom-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .custom-table th {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      color: #495057;
      font-weight: 600;
      padding: 1rem;
      border-bottom: 2px solid #dee2e6;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }

    .custom-table td {
      padding: 1rem;
      border-bottom: 1px solid #f1f3f4;
      vertical-align: middle;
    }

    .custom-table tbody tr:hover {
      background: #f8f9fa;
      transform: scale(1.01);
      transition: all 0.2s ease;
    }

    .student-photo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Alert Styles */
    .custom-alert {
      border-radius: 15px;
      border: none;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
    }

    .custom-alert.success {
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      color: #155724;
    }

    .custom-alert.info {
      background: linear-gradient(135deg, #d1ecf1, #bee5eb);
      color: #0c5460;
    }

    .custom-alert.danger {
      background: linear-gradient(135deg, #f8d7da, #f5c6cb);
      color: #721c24;
    }

    /* Loading Animation */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .dashboard-content {
        padding: 1rem;
      }

      .top-nav {
        padding: 1rem;
      }

      .section-header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }

      .section-body {
        padding: 1rem;
      }
    }

    /* Toggle Button for Mobile */
    .sidebar-toggle {
      display: none;
      background: var(--primary-color);
      border: none;
      color: white;
      padding: 0.5rem;
      border-radius: 5px;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1001;
      transition: all 0.3s ease;
    }

    .sidebar-toggle:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }

    @media (max-width: 768px) {
      .sidebar-toggle {
        display: block;
      }
    }

    /* Overlay for mobile */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    @media (max-width: 768px) {
      .sidebar-overlay.active {
        display: block;
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: #666;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }

    .empty-state h5 {
      margin-bottom: 0.5rem;
      color: #333;
    }

    /* Submenu Styles */
    .has-submenu .submenu {
      background: #198754;
      padding-left: 2rem;
      border-radius: 0 0 10px 10px;
    }
    .has-submenu .submenu .nav-link {
      color: #ffc107;
      font-size: 0.95rem;
    }
    .has-submenu .submenu .nav-link:hover {
      background: rgba(255,255,255,0.1);
    }

    /* Custom style for settings tabs */
    #settingsTabs .nav-link {
      background: #e9ecef;
      color: #198754;
      border: none;
      margin: 0 10px;
      border-radius: 8px 8px 0 0;
      font-weight: 600;
      transition: background 0.2s, color 0.2s;
      min-width: 120px;
    }
    #settingsTabs .nav-link.active {
      background: #198754;
      color: #fff;
      box-shadow: 0 4px 12px rgba(25,135,84,0.08);
    }
    #settingsTabs .nav-link:hover:not(.active) {
      background: #d1e7dd;
      color: #146c43;
    }

    /* Settings Panel Card & Header */
    .settings-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 0 0 2rem 0;
      margin-top: 2rem;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    .settings-header-bar {
      background: linear-gradient(90deg, #198754 0%, #0d6efd 100%);
      color: #fff;
      border-radius: 16px 16px 0 0;
      padding: 1.5rem 2rem 1rem 2rem;
      margin-bottom: 0.5rem;
      box-shadow: 0 2px 8px rgba(25,135,84,0.08);
    }
    /* Dark mode styles */
    body.dark-mode {
      background: #181c1f !important;
      color: #e9ecef !important;
    }
    body.dark-mode .settings-card {
      background: #23272b;
      color: #e9ecef;
      box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    }
    body.dark-mode .settings-header-bar {
      background: linear-gradient(90deg, #146c43 0%, #0d6efd 100%);
      color: #fff;
    }
    body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
      background: #23272b !important;
      color: #e9ecef !important;
      border-color: #444 !important;
    }
    body.dark-mode .nav-tabs .nav-link {
      background: #23272b !important;
      color: #fff !important;
    }
    body.dark-mode .nav-tabs .nav-link.active {
      background: #0d6efd !important;
      color: #fff !important;
    }
    body.dark-mode .btn {
      border-color: #444 !important;
    }
    body.dark-mode .custom-alert, body.dark-mode .alert {
      background: #23272b !important;
      color: #fff !important;
      border-color: #444 !important;
    }
    /* Sidebar collapse */
    .sidebar.collapsed {
      width: 70px !important;
      min-width: 70px !important;
      transition: width 0.3s;
    }
    .sidebar.collapsed .sidebar-header, .sidebar.collapsed .nav-menu, .sidebar.collapsed .nav-link span, .sidebar.collapsed .sidebar-header p {
      display: none !important;
    }
    .sidebar.collapsed .nav-link i {
      margin-right: 0 !important;
    }
    .main-content.sidebar-collapsed {
      margin-left: 70px !important;
      transition: margin-left 0.3s;
    }
    /* Settings submenu styles */
    .has-submenu .submenu {
      background: #198754;
      padding-left: 2rem;
      border-radius: 0 0 10px 10px;
    }
    .has-submenu .submenu .nav-link {
      color: #ffc107;
      font-size: 0.95rem;
      margin-bottom: 2px;
      border-radius: 6px;
      transition: background 0.2s, color 0.2s;
    }
    .has-submenu .submenu .nav-link.active {
      background: #fff;
      color: #198754;
      font-weight: 600;
    }
    .has-submenu .submenu .nav-link:hover:not(.active) {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }
  </style>
</head>
<body>
  <!-- Mobile Toggle Button -->
  <button class="sidebar-toggle" id="sidebarToggle">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3><i class="fas fa-graduation-cap me-2"></i>VJP ADMIN</h3>
      <p>Management Dashboard</p>
    </div>
    
    <div class="nav-menu">
      <div class="nav-item">
        <a class="nav-link active" href="#" data-section="dashboard">
          <i class="fas fa-tachometer-alt"></i>
          <span data-i18n="dashboard">Dashboard</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="#" data-section="users">
          <i class="fas fa-users"></i>
          <span data-i18n="manage_users">Manage Users</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="#" data-section="students">
          <i class="fas fa-user-graduate"></i>
          <span data-i18n="all_students">All Students</span>
        </a>
      </div>
      <div class="nav-item">
        <a class="nav-link" href="#" data-section="teachers">
          <i class="fas fa-chalkboard-teacher"></i>
          <span data-i18n="all_teachers">All Teachers</span>
        </a>
      </div>
      <div class="nav-item has-submenu">
        <a class="nav-link" href="#" id="manageLoginMenu">
          <i class="fas fa-user-cog"></i>
          <span data-i18n="manage_login">Manage Login</span>
          <i class="fas fa-chevron-down ms-2"></i>
        </a>
        <div class="submenu" id="manageLoginSubmenu" style="display: none;">
          <a class="nav-link" href="#" data-section="manageLoginAll">
            <span data-i18n="all">All</span>
          </a>
          <a class="nav-link" href="#" data-section="manageLoginTeachers">
            <span data-i18n="all_teachers">Teachers</span>
          </a>
          <a class="nav-link" href="#" data-section="manageLoginStudents">
            <span data-i18n="all_students">Students</span>
          </a>
        </div>
      </div>
      <div class="nav-item has-submenu">
        <a class="nav-link" href="#" id="settingsMenu">
          <i class="fas fa-cog"></i>
          <span data-i18n="settings">Settings</span>
          <i class="fas fa-chevron-down ms-2"></i>
        </a>
        <div class="submenu" id="settingsSubmenu" style="display: none;">
          <a class="nav-link" href="#" data-settings-tab="profile">
            <span data-i18n="profile">Profile</span>
          </a>
          <a class="nav-link" href="#" data-settings-tab="security">
            <span data-i18n="security">Security</span>
          </a>
          <a class="nav-link" href="#" data-settings-tab="appearance">
            <span data-i18n="appearance">Appearance</span>
          </a>
          <a class="nav-link" href="#" data-settings-tab="other">
            <span data-i18n="other">Other</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Navigation -->
    <div class="top-nav">
      <div class="top-nav-content">
        <div class="welcome-text">
          <span data-i18n="welcome_message">Welcome back, <span class="admin-name" id="adminName">Admin</span>! üëã</span>
        </div>
        <button class="logout-btn" id="logoutBtn">
          <i class="fas fa-sign-out-alt me-2"></i>
          <span data-i18n="logout">Logout</span>
        </button>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
      <!-- Dashboard Section -->
      <div id="dashboardSection" class="content-section">
        <div class="section-header">
          <h4><i class="fas fa-tachometer-alt me-2"></i>
            <span data-i18n="dashboard_overview">Dashboard Overview</span>
          </h4>
          <div>
            <button class="btn btn-light btn-sm me-2" onclick="dashboard.loadDashboardStats()" title="Refresh Data">
              <i class="fas fa-sync-alt"></i>
              <span data-i18n="refresh">Refresh</span>
            </button>
            <button class="btn btn-outline-info btn-sm" onclick="dashboard.testAuth()" title="Test Authentication">
              <i class="fas fa-key"></i>
              <span data-i18n="test_auth">Test Auth</span>
            </button>
          </div>
        </div>
        <div class="section-body">
          <!-- Statistics Cards -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon text-primary">
                <i class="fas fa-user-graduate"></i>
              </div>
              <div class="stat-number" id="totalStudents">0</div>
              <div class="stat-label">
                <span data-i18n="total_students">Total Students</span>
              </div>
            </div>
            
            <div class="stat-card blue">
              <div class="stat-icon text-primary">
                <i class="fas fa-chalkboard-teacher"></i>
              </div>
              <div class="stat-number" id="totalTeachers">0</div>
              <div class="stat-label">
                <span data-i18n="total_teachers">Total Teachers</span>
              </div>
            </div>
            
            <div class="stat-card orange">
              <div class="stat-icon text-warning">
                <i class="fas fa-clock"></i>
              </div>
              <div class="stat-number" id="pendingRequests">0</div>
              <div class="stat-label">
                <span data-i18n="pending_requests">Pending Requests</span>
              </div>
            </div>
            
            <div class="stat-card purple">
              <div class="stat-icon text-info">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="stat-number" id="approvedUsers">0</div>
              <div class="stat-label">
                <span data-i18n="approved_users">Approved Users</span>
              </div>
            </div>
          </div>

          <!-- Welcome Message -->
          <div class="custom-alert success">
            <h5><i class="fas fa-info-circle me-2"></i>
              <span data-i18n="welcome_info">Welcome to VIRTI JAIN PATHSHALA Admin Panel</span>
            </h5>
            <p class="mb-0">
              <span data-i18n="welcome_description">Manage your institution efficiently with our comprehensive dashboard. Use the sidebar to navigate between different sections.</span>
            </p>
          </div>
        </div>
      </div>

      <!-- Students Section -->
      <div id="studentsSection" class="content-section" style="display: none;">
        <div class="section-header">
          <h4><i class="fas fa-user-graduate me-2"></i>
            <span data-i18n="all_approved_students">All Approved Students</span>
          </h4>
          <div>
            <span class="badge bg-light text-dark" id="studentCount">0 students</span>
          </div>
        </div>
        <div class="section-body">
          <div id="studentsTable">
            <div class="empty-state">
              <i class="fas fa-spinner loading-spinner"></i>
              <h5>
                <span data-i18n="loading_students">Loading students...</span>
              </h5>
              <p>
                <span data-i18n="loading_students_description">Please wait while we fetch the student data.</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Teachers Section -->
      <div id="teachersSection" class="content-section" style="display: none;">
        <div class="section-header">
          <h4><i class="fas fa-chalkboard-teacher me-2"></i>
            <span data-i18n="all_teachers">All Teachers</span>
          </h4>
          <div>
            <span class="badge bg-light text-dark" id="teacherCount">0 teachers</span>
          </div>
        </div>
        <div class="section-body">
          <div id="teachersTable">
            <div class="empty-state">
              <i class="fas fa-spinner loading-spinner"></i>
              <h5>
                <span data-i18n="loading_teachers">Loading teachers...</span>
              </h5>
              <p>
                <span data-i18n="loading_teachers_description">Please wait while we fetch the teacher data.</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div id="usersSection" class="content-section" style="display: none;">
        <div class="section-header">
          <h4><i class="fas fa-users me-2"></i>
            <span data-i18n="manage_users">Manage Users</span>
          </h4>
          <div>
            <button class="btn btn-success btn-sm me-2" id="addUserBtn"><i class="fas fa-user-plus"></i> Add User</button>
            <button class="btn btn-outline-primary btn-sm me-2" id="exportUsersBtn"><i class="fas fa-file-export"></i> Export</button>
            <button class="btn btn-outline-danger btn-sm" id="bulkDeleteBtn" disabled><i class="fas fa-trash"></i> Delete Selected</button>
          </div>
        </div>
        <div class="section-body">
          <ul class="nav nav-tabs mb-3" id="userTypeTabs">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-type="TEACHER">Teachers</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-type="STUDENT">Students</a>
            </li>
          </ul>
          <div id="usersTableContainer">
            <div class="empty-state">
              <i class="fas fa-spinner loading-spinner"></i>
              <h5>Loading users...</h5>
            </div>
          </div>
        </div>
      </div>
      <!-- Add/Edit User Modal -->
      <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="userModalLabel">Add/Edit User</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="userForm">
              <div class="modal-body">
                <input type="hidden" id="userIdInput">
                <div class="mb-3">
                  <label class="form-label">Full Name</label>
                  <input type="text" class="form-control" id="userFullNameInput" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" id="userEmailInput" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Mobile</label>
                  <input type="text" class="form-control" id="userMobileInput">
                </div>
                <div class="mb-3">
                  <label class="form-label">Role</label>
                  <select class="form-select" id="userRoleInput" required>
                    <option value="ADMIN">Admin</option>
                    <option value="TEACHER">Teacher</option>
                    <option value="STUDENT">Student</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Status</label>
                  <select class="form-select" id="userStatusInput">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                  </select>
                </div>
                <div class="mb-3" id="userPasswordGroup">
                  <label class="form-label">Password</label>
                  <input type="password" class="form-control" id="userPasswordInput" autocomplete="new-password">
                  <div class="form-text" id="userPasswordHelp">Leave blank to keep current password (edit mode).</div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success" id="saveUserBtn">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Manage Login Section -->
      <div id="manageLoginSection" class="content-section" style="display: none;">
        <div class="section-header">
          <h4><i class="fas fa-user-cog me-2"></i>
            <span data-i18n="manage_login">Manage Login</span>
          </h4>
        </div>
        <div class="section-body">
          <div id="manageLoginMsg"></div>
          <div id="manageLoginTable">
          <div class="empty-state">
              <i class="fas fa-spinner loading-spinner"></i>
              <h5>
                <span data-i18n="loading_users">Loading users...</span>
              </h5>
              <p>
                <span data-i18n="loading_users_description">Please wait while we fetch the user data.</span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div id="settingsSection" class="content-section settings-card" style="display: none;">
        <div class="settings-header-bar">
          <h4><i class="fas fa-cog me-2"></i>
            <span data-i18n="settings_panel">Settings Panel</span>
          </h4>
        </div>
        <div class="section-body">
          <div id="settingsTabContent">
            <!-- Profile Tab -->
            <div id="profileTab" class="settings-tab-pane" style="display: none;">
              <form class="row g-3 mb-4" id="profileForm">
                <div class="col-md-3 text-center">
                  <img src="/uploads/default.png" id="profilePhotoPreview" class="rounded-circle mb-2" style="width: 100px; height: 100px; object-fit: cover; border: 3px solid #eee;">
                  <input type="file" class="form-control form-control-sm mt-2" id="profilePhotoInput" accept="image/*" disabled>
                </div>
                <div class="col-md-9">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">
                        <span data-i18n="full_name">Full Name</span>
                      </label>
                      <input type="text" class="form-control" id="profileName" value="" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">
                        <span data-i18n="email">Email</span>
                      </label>
                      <input type="email" class="form-control" id="profileEmail" value="" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">
                        <span data-i18n="mobile">Mobile</span>
                      </label>
                      <input type="text" class="form-control" id="profileMobile" value="" readonly>
                    </div>
                  </div>
                  <div class="mt-3">
                    <button type="button" class="btn btn-primary" id="editProfileBtn">
                      <span data-i18n="edit">Edit</span>
                    </button>
                    <button type="button" class="btn btn-success d-none" id="saveProfileBtn">
                      <span data-i18n="save">Save</span>
                    </button>
                    <button type="button" class="btn btn-secondary d-none" id="cancelProfileBtn">
                      <span data-i18n="cancel">Cancel</span>
                    </button>
                  </div>
                  <div id="profileMsg" class="mt-2"></div>
                </div>
              </form>
            </div>
            <!-- Security Tab -->
            <div id="securityTab" class="settings-tab-pane" style="display: none;">
              <div class="mb-4">
                <h5>
                  <span data-i18n="two_factor_auth">Two-Factor Authentication (2FA)</span>
                </h5>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="enable2FA" disabled>
                  <label class="form-check-label" for="enable2FA">
                    <span data-i18n="enable_2fa">Enable 2FA (Coming Soon)</span>
                  </label>
                </div>
              </div>
              <div>
                <h5>
                  <span data-i18n="login_history">Login History / Activity Log</span>
                </h5>
                <div class="alert alert-info">
                  <span data-i18n="login_history_description">Login history and activity log will be shown here. (Future feature)</span>
                </div>
              </div>
            </div>
            <!-- Appearance Tab -->
            <div id="appearanceTab" class="settings-tab-pane" style="display: none;">
              <div class="mb-4">
                <h5>
                  <span data-i18n="theme">Theme</span>
                </h5>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="darkModeToggle">
                  <label class="form-check-label" for="darkModeToggle">
                    <span data-i18n="dark_mode">Dark Mode</span>
                  </label>
                </div>
              </div>
              <div>
                <h5>
                  <span data-i18n="sidebar">Sidebar</span>
                </h5>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="sidebarCollapseToggle">
                  <label class="form-check-label" for="sidebarCollapseToggle">
                    <span data-i18n="collapse_sidebar">Collapse Sidebar</span>
                  </label>
                </div>
              </div>
            </div>
            <!-- Other Tab -->
            <div id="otherTab" class="settings-tab-pane" style="display: none;">
              <div class="mb-4">
                <h5>
                  <span data-i18n="language_preference">Language Preference</span>
                </h5>
                <select class="form-select w-auto" id="languageSelect">
                  <option value="en">English</option>
                  <option value="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</option>
                  <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                </select>
              </div>
              <div class="mb-4">
                <button class="btn btn-outline-danger me-2" id="logoutAllBtn">
                  <span data-i18n="logout_all">Logout from All Devices</span>
                </button>
                <button class="btn btn-outline-secondary" id="deleteAccountBtn">
                  <span data-i18n="delete_account">Delete/Disable Account</span>
                </button>
              </div>
              <div id="deleteAccountConfirm" class="alert alert-warning d-none">
                <strong>
                  <span data-i18n="delete_account_confirm_question">Are you sure?</span>
                </strong>
                <span data-i18n="delete_account_confirm_description">This will permanently delete or disable your account.</span><br>
                <button class="btn btn-danger btn-sm mt-2" id="confirmDeleteBtn">
                  <span data-i18n="confirm_delete">Yes, Delete My Account</span>
                </button>
                <button class="btn btn-secondary btn-sm mt-2 ms-2" id="cancelDeleteBtn">
                  <span data-i18n="cancel_delete">Cancel</span>
                </button>
              </div>
              <div id="otherMsg" class="mt-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 2FA Modal -->
  <div class="modal fade" id="twoFAModal" tabindex="-1" aria-labelledby="twoFAModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="twoFAModalLabel">Enable Two-Factor Authentication (2FA)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="twoFAQrSection" class="mb-3 text-center"></div>
          <div class="mb-3">
            <label for="twoFACodeInput" class="form-label">Enter 6-digit code from your Authenticator app</label>
            <input type="text" class="form-control" id="twoFACodeInput" maxlength="6" autocomplete="one-time-code">
          </div>
          <div id="twoFAMsg" class="mb-2"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="verify2FABtn">Verify & Enable</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- TRANSLATIONS DICTIONARY ---
    const translations = {
      en: {
        dashboard: "Dashboard",
        manage_users: "Manage Users",
        all_students: "All Students",
        all_teachers: "All Teachers",
        manage_login: "Manage Login",
        settings: "Settings",
        profile: "Profile",
        security: "Security",
        appearance: "Appearance",
        other: "Other",
        logout: "Logout",
        dashboard_overview: "Dashboard Overview",
        refresh: "Refresh",
        test_auth: "Test Auth",
        total_students: "Total Students",
        total_teachers: "Total Teachers",
        pending_requests: "Pending Requests",
        approved_users: "Approved Users",
        welcome_info: "Welcome to VIRTI JAIN PATHSHALA Admin Panel",
        welcome_description: "Manage your institution efficiently with our comprehensive dashboard. Use the sidebar to navigate between different sections.",
        all_approved_students: "All Approved Students",
        loading_students: "Loading students...",
        loading_students_description: "Please wait while we fetch the student data.",
        loading_teachers: "Loading teachers...",
        loading_teachers_description: "Please wait while we fetch the teacher data.",
        user_management: "User Management",
        user_management_description: "User management features will be available soon.",
        loading_users: "Loading users...",
        loading_users_description: "Please wait while we fetch the user data.",
        settings_panel: "Settings Panel",
        full_name: "Full Name",
        email: "Email",
        mobile: "Mobile",
        edit: "Edit",
        save: "Save",
        cancel: "Cancel",
        two_factor_auth: "Two-Factor Authentication (2FA)",
        enable_2fa: "Enable 2FA (Coming Soon)",
        login_history: "Login History / Activity Log",
        login_history_description: "Login history and activity log will be shown here. (Future feature)",
        theme: "Theme",
        dark_mode: "Dark Mode",
        sidebar: "Sidebar",
        collapse_sidebar: "Collapse Sidebar",
        language_preference: "Language Preference",
        logout_all: "Logout from All Devices",
        delete_account: "Delete/Disable Account",
        delete_account_confirm_question: "Are you sure?",
        delete_account_confirm_description: "This will permanently delete or disable your account.",
        confirm_delete: "Yes, Delete My Account",
        cancel_delete: "Cancel",
        // ...add more as needed
      },
      gu: {
        dashboard: "‡™°‡´á‡™∂‡™¨‡´ã‡™∞‡´ç‡™°",
        manage_users: "‡™µ‡™™‡™∞‡™æ‡™∂‡™ï‡™∞‡´ç‡™§‡™æ ‡™µ‡´ç‡™Ø‡™µ‡™∏‡´ç‡™•‡™æ‡™™‡™ø‡™§ ‡™ï‡™∞‡´ã",
        all_students: "‡™¨‡™ß‡™æ ‡™µ‡™ø‡™¶‡´ç‡™Ø‡™æ‡™∞‡´ç‡™•‡´Ä‡™ì",
        all_teachers: "‡™¨‡™ß‡™æ ‡™∂‡™ø‡™ï‡´ç‡™∑‡™ï‡´ã",
        manage_login: "‡™≤‡´â‡™ó‡™ø‡™® ‡™µ‡´ç‡™Ø‡™µ‡™∏‡´ç‡™•‡™æ‡™™‡™ø‡™§ ‡™ï‡™∞‡´ã",
        settings: "‡™∏‡´á‡™ü‡™ø‡™Ç‡™ó‡´ç‡™∏",
        profile: "‡™™‡´ç‡™∞‡´ã‡™´‡™æ‡™á‡™≤",
        security: "‡™∏‡´Å‡™∞‡™ï‡´ç‡™∑‡™æ",
        appearance: "‡™¶‡´á‡™ñ‡™æ‡™µ",
        other: "‡™Ö‡™®‡´ç‡™Ø",
        logout: "‡™≤‡´â‡™ó‡™Ü‡™â‡™ü",
        dashboard_overview: "‡™°‡´á‡™∂‡™¨‡´ã‡™∞‡´ç‡™° ‡™ù‡™æ‡™Ç‡™ñ‡´Ä",
        refresh: "‡™∞‡™ø‡™´‡´ç‡™∞‡´á‡™∂",
        test_auth: "‡™ü‡´á‡™∏‡´ç‡™ü ‡™ì‡™•",
        total_students: "‡™ï‡´Å‡™≤ ‡™µ‡™ø‡™¶‡´ç‡™Ø‡™æ‡™∞‡´ç‡™•‡´Ä‡™ì",
        total_teachers: "‡™ï‡´Å‡™≤ ‡™∂‡™ø‡™ï‡´ç‡™∑‡™ï‡´ã",
        pending_requests: "‡™¨‡™æ‡™ï‡´Ä ‡™µ‡™ø‡™®‡™Ç‡™§‡´Ä‡™ì",
        approved_users: "‡™Æ‡™Ç‡™ú‡´Ç‡™∞ ‡™µ‡™™‡™∞‡™æ‡™∂‡™ï‡™∞‡´ç‡™§‡™æ",
        welcome_info: "‡™µ‡™∞‡´ç‡™§‡´Ä ‡™ú‡´à‡™® ‡™™‡™æ‡™†‡™∂‡™æ‡™≥‡™æ ‡™è‡™°‡™Æ‡™ø‡™® ‡™™‡´á‡™®‡™≤‡™Æ‡™æ‡™Ç ‡™Ü‡™™‡™®‡´Å‡™Ç ‡™∏‡´ç‡™µ‡™æ‡™ó‡™§ ‡™õ‡´á",
        welcome_description: "‡™Ö‡™Æ‡™æ‡™∞‡™æ ‡™µ‡´ç‡™Ø‡™æ‡™™‡™ï ‡™°‡´á‡™∂‡™¨‡´ã‡™∞‡´ç‡™° ‡™∏‡™æ‡™•‡´á ‡™§‡™Æ‡™æ‡™∞‡´Ä ‡™∏‡™Ç‡™∏‡´ç‡™•‡™æ ‡™ï‡™æ‡™∞‡´ç‡™Ø‡™ï‡´ç‡™∑‡™Æ ‡™∞‡´Ä‡™§‡´á ‡™∏‡™Ç‡™ö‡™æ‡™≤‡™ø‡™§ ‡™ï‡™∞‡´ã. ‡™µ‡™ø‡™µ‡™ø‡™ß ‡™µ‡™ø‡™≠‡™æ‡™ó‡´ã‡™Æ‡™æ‡™Ç ‡™®‡´á‡™µ‡™ø‡™ó‡´á‡™ü ‡™ï‡™∞‡™µ‡™æ ‡™Æ‡™æ‡™ü‡´á ‡™∏‡™æ‡™á‡™°‡™¨‡™æ‡™∞‡™®‡´ã ‡™â‡™™‡™Ø‡´ã‡™ó ‡™ï‡™∞‡´ã.",
        all_approved_students: "‡™¨‡™ß‡™æ ‡™Æ‡™Ç‡™ú‡´Ç‡™∞ ‡™µ‡™ø‡™¶‡´ç‡™Ø‡™æ‡™∞‡´ç‡™•‡´Ä‡™ì",
        loading_students: "‡™µ‡™ø‡™¶‡´ç‡™Ø‡™æ‡™∞‡´ç‡™•‡´Ä‡™ì ‡™≤‡´ã‡™° ‡™•‡™à ‡™∞‡™π‡´ç‡™Ø‡™æ ‡™õ‡´á...",
        loading_students_description: "‡™ï‡´É‡™™‡™æ ‡™ï‡™∞‡´Ä‡™®‡´á ‡™∞‡™æ‡™π ‡™ú‡´Å‡™ì, ‡™Ö‡™Æ‡´á ‡™µ‡™ø‡™¶‡´ç‡™Ø‡™æ‡™∞‡´ç‡™•‡´Ä ‡™°‡´á‡™ü‡™æ ‡™≤‡™æ‡™µ‡´Ä ‡™∞‡™π‡´ç‡™Ø‡™æ ‡™õ‡´Ä‡™è.",
        loading_teachers: "‡™∂‡™ø‡™ï‡´ç‡™∑‡™ï‡´ã ‡™≤‡´ã‡™° ‡™•‡™à ‡™∞‡™π‡´ç‡™Ø‡™æ ‡™õ‡´á...",
        loading_teachers_description: "‡™ï‡´É‡™™‡™æ ‡™ï‡™∞‡´Ä‡™®‡´á ‡™∞‡™æ‡™π ‡™ú‡´Å‡™ì, ‡™Ö‡™Æ‡´á ‡™∂‡™ø‡™ï‡´ç‡™∑‡™ï ‡™°‡´á‡™ü‡™æ ‡™≤‡™æ‡™µ‡´Ä ‡™∞‡™π‡´ç‡™Ø‡™æ ‡™õ‡´Ä‡™è.",
        user_management: "‡™µ‡™™‡™∞‡™æ‡™∂‡™ï‡™∞‡´ç‡™§‡™æ ‡™µ‡´ç‡™Ø‡™µ‡™∏‡´ç‡™•‡™æ‡™™‡™®",
        user_management_description: "‡™µ‡™™‡™∞‡™æ‡™∂‡™ï‡™∞‡´ç‡™§‡™æ ‡™µ‡´ç‡™Ø‡™µ‡™∏‡´ç‡™•‡™æ‡™™‡™® ‡™∏‡´Å‡™µ‡™ø‡™ß‡™æ‡™ì ‡™ü‡´Ç‡™Ç‡™ï ‡™∏‡™Æ‡™Ø‡™Æ‡™æ‡™Ç ‡™â‡™™‡™≤‡™¨‡´ç‡™ß ‡™•‡™∂‡´á.",
        loading_users: "‡™µ‡™™‡™∞‡™æ‡™∂‡™ï‡™∞‡´ç‡™§‡™æ‡™ì ‡™≤‡´ã‡™° ‡™•‡™à ‡™∞‡™π‡´ç‡™Ø‡™æ ‡™õ‡´á...",
        loading_users_description: "‡™ï‡´É‡™™‡™æ ‡™ï‡™∞‡´Ä‡™®‡´á ‡™∞‡™æ‡™π ‡™ú‡´Å‡™ì, ‡™Ö‡™Æ‡´á ‡™µ‡™™‡™∞‡™æ‡™∂‡™ï‡™∞‡´ç‡™§‡™æ ‡™°‡´á‡™ü‡™æ ‡™≤‡™æ‡™µ‡´Ä ‡™∞‡™π‡´ç‡™Ø‡™æ ‡™õ‡´Ä‡™è.",
        settings_panel: "‡™∏‡´á‡™ü‡™ø‡™Ç‡™ó‡´ç‡™∏ ‡™™‡´á‡™®‡™≤",
        full_name: "‡™™‡´Ç‡™∞‡´ç‡™£ ‡™®‡™æ‡™Æ",
        email: "‡™á‡™Æ‡´á‡™á‡™≤",
        mobile: "‡™Æ‡´ã‡™¨‡™æ‡™á‡™≤",
        edit: "‡™∏‡™Ç‡™™‡™æ‡™¶‡™ø‡™§ ‡™ï‡™∞‡´ã",
        save: "‡™∏‡´á‡™µ ‡™ï‡™∞‡´ã",
        cancel: "‡™∞‡™¶ ‡™ï‡™∞‡´ã",
        two_factor_auth: "‡™ü‡´Ç-‡™´‡´á‡™ï‡´ç‡™ü‡™∞ ‡™ì‡™•‡™®‡´ç‡™ü‡™ø‡™ï‡´á‡™∂‡™® (2FA)",
        enable_2fa: "2FA ‡™∏‡™ï‡´ç‡™∞‡™ø‡™Ø ‡™ï‡™∞‡´ã (‡™ü‡´Ç‡™Ç‡™ï ‡™∏‡™Æ‡™Ø‡™Æ‡™æ‡™Ç)",
        login_history: "‡™≤‡´â‡™ó‡™ø‡™® ‡™á‡™§‡™ø‡™π‡™æ‡™∏ / ‡™™‡´ç‡™∞‡™µ‡´É‡™§‡´ç‡™§‡™ø ‡™≤‡´ã‡™ó",
        login_history_description: "‡™≤‡´â‡™ó‡™ø‡™® ‡™á‡™§‡™ø‡™π‡™æ‡™∏ ‡™Ö‡™®‡´á ‡™™‡´ç‡™∞‡™µ‡´É‡™§‡´ç‡™§‡™ø ‡™≤‡´ã‡™ó ‡™Ö‡™π‡´Ä‡™Ç ‡™¨‡™§‡™æ‡™µ‡™µ‡™æ‡™Æ‡™æ‡™Ç ‡™Ü‡™µ‡™∂‡´á. (‡™≠‡™µ‡™ø‡™∑‡´ç‡™Ø‡™®‡´Ä ‡™∏‡´Å‡™µ‡™ø‡™ß‡™æ)",
        theme: "‡™•‡´Ä‡™Æ",
        dark_mode: "‡™°‡™æ‡™∞‡´ç‡™ï ‡™Æ‡´ã‡™°",
        sidebar: "‡™∏‡™æ‡™á‡™°‡™¨‡™æ‡™∞",
        collapse_sidebar: "‡™∏‡™æ‡™á‡™°‡™¨‡™æ‡™∞ ‡™∏‡™Ç‡™ï‡´ã‡™ö‡´ã",
        language_preference: "‡™≠‡™æ‡™∑‡™æ ‡™™‡™∏‡™Ç‡™¶‡™ó‡´Ä",
        logout_all: "‡™¨‡™ß‡™æ ‡™â‡™™‡™ï‡™∞‡™£‡´ã‡™Æ‡™æ‡™Ç‡™•‡´Ä ‡™≤‡´â‡™ó‡™Ü‡™â‡™ü ‡™ï‡™∞‡´ã",
        delete_account: "‡™è‡™ï‡™æ‡™â‡™®‡´ç‡™ü ‡™°‡™ø‡™≤‡´Ä‡™ü/‡™°‡™ø‡™∏‡´á‡™¨‡™≤ ‡™ï‡™∞‡´ã",
        delete_account_confirm_question: "‡™∂‡´Å‡™Ç ‡™§‡™Æ‡´á ‡™ñ‡™æ‡™§‡™∞‡´Ä ‡™ï‡™∞‡´ã ‡™õ‡´ã?",
        delete_account_confirm_description: "‡™Ü ‡™§‡™Æ‡™æ‡™∞‡™æ ‡™è‡™ï‡™æ‡™â‡™®‡´ç‡™ü‡™®‡´á ‡™ï‡™æ‡™Ø‡™Æ ‡™Æ‡™æ‡™ü‡´á ‡™°‡™ø‡™≤‡´Ä‡™ü ‡™Ö‡™•‡™µ‡™æ ‡™°‡™ø‡™∏‡´á‡™¨‡™≤ ‡™ï‡™∞‡™∂‡´á.",
        confirm_delete: "‡™π‡™æ, ‡™Æ‡™æ‡™∞‡´Å‡™Ç ‡™è‡™ï‡™æ‡™â‡™®‡´ç‡™ü ‡™°‡™ø‡™≤‡´Ä‡™ü ‡™ï‡™∞‡´ã",
        cancel_delete: "‡™∞‡™¶ ‡™ï‡™∞‡´ã",
        // ...add more as needed
      },
      hi: {
        dashboard: "‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°",
        manage_users: "‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®",
        all_students: "‡§∏‡§≠‡•Ä ‡§õ‡§æ‡§§‡•ç‡§∞",
        all_teachers: "‡§∏‡§≠‡•Ä ‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï",
        manage_login: "‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®",
        settings: "‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏",
        profile: "‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤",
        security: "‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ",
        appearance: "‡§∞‡•Ç‡§™",
        other: "‡§Ö‡§®‡•ç‡§Ø",
        logout: "‡§≤‡•â‡§ó‡§Ü‡§â‡§ü",
        dashboard_overview: "‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§Ö‡§µ‡§≤‡•ã‡§ï‡§®",
        refresh: "‡§∞‡§ø‡§´‡•ç‡§∞‡•á‡§∂",
        test_auth: "‡§ü‡•á‡§∏‡•ç‡§ü ‡§ë‡§•",
        total_students: "‡§ï‡•Å‡§≤ ‡§õ‡§æ‡§§‡•ç‡§∞",
        total_teachers: "‡§ï‡•Å‡§≤ ‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï",
        pending_requests: "‡§≤‡§Ç‡§¨‡§ø‡§§ ‡§Ö‡§®‡•Å‡§∞‡•ã‡§ß",
        approved_users: "‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§ ‡§Ø‡•Ç‡§ú‡§º‡§∞",
        welcome_info: "‡§µ‡§ø‡§∞‡§§‡•Ä ‡§ú‡•à‡§® ‡§™‡§æ‡§†‡§∂‡§æ‡§≤‡§æ ‡§è‡§°‡§Æ‡§ø‡§® ‡§™‡•à‡§®‡§≤ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à",
        welcome_description: "‡§π‡§Æ‡§æ‡§∞‡•á ‡§µ‡•ç‡§Ø‡§æ‡§™‡§ï ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§ï‡•á ‡§∏‡§æ‡§• ‡§Ö‡§™‡§®‡•á ‡§∏‡§Ç‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡§æ ‡§ï‡•Å‡§∂‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§µ‡§ø‡§≠‡§ø‡§®‡•ç‡§® ‡§Ö‡§®‡•Å‡§≠‡§æ‡§ó‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§",
        all_approved_students: "‡§∏‡§≠‡•Ä ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§ ‡§õ‡§æ‡§§‡•ç‡§∞",
        loading_students: "‡§õ‡§æ‡§§‡•ç‡§∞ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...",
        loading_students_description: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§π‡§Æ ‡§õ‡§æ‡§§‡•ç‡§∞ ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§",
        loading_teachers: "‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...",
        loading_teachers_description: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§π‡§Æ ‡§∂‡§ø‡§ï‡•ç‡§∑‡§ï ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§",
        user_management: "‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®",
        user_management_description: "‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ‡§è‡§Å ‡§ú‡§≤‡•ç‡§¶ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•ã‡§Ç‡§ó‡•Ä‡•§",
        loading_users: "‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...",
        loading_users_description: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§π‡§Æ ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç‡•§",
        settings_panel: "‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§™‡•à‡§®‡§≤",
        full_name: "‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ",
        email: "‡§à‡§Æ‡•á‡§≤",
        mobile: "‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤",
        edit: "‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç",
        save: "‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç",
        cancel: "‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
        two_factor_auth: "‡§¶‡•ã-‡§ö‡§∞‡§£‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£ (2FA)",
        enable_2fa: "2FA ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§ï‡§∞‡•á‡§Ç (‡§ú‡§≤‡•ç‡§¶ ‡§Ü ‡§∞‡§π‡§æ ‡§π‡•à)",
        login_history: "‡§≤‡•â‡§ó‡§ø‡§® ‡§á‡§§‡§ø‡§π‡§æ‡§∏ / ‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø ‡§≤‡•â‡§ó",
        login_history_description: "‡§≤‡•â‡§ó‡§ø‡§® ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§î‡§∞ ‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø ‡§≤‡•â‡§ó ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§Ø‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ‡•§ (‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§ï‡•Ä ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ)",
        theme: "‡§•‡•Ä‡§Æ",
        dark_mode: "‡§°‡§æ‡§∞‡•ç‡§ï ‡§Æ‡•ã‡§°",
        sidebar: "‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞",
        collapse_sidebar: "‡§∏‡§æ‡§á‡§°‡§¨‡§æ‡§∞ ‡§∏‡§Ç‡§ï‡•Å‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç",
        language_preference: "‡§≠‡§æ‡§∑‡§æ ‡§™‡§∏‡§Ç‡§¶",
        logout_all: "‡§∏‡§≠‡•Ä ‡§°‡§ø‡§µ‡§æ‡§á‡§∏ ‡§∏‡•á ‡§≤‡•â‡§ó‡§Ü‡§â‡§ü ‡§ï‡§∞‡•á‡§Ç",
        delete_account: "‡§ñ‡§æ‡§§‡§æ ‡§π‡§ü‡§æ‡§è‡§Å/‡§Ö‡§ï‡•ç‡§∑‡§Æ ‡§ï‡§∞‡•á‡§Ç",
        delete_account_confirm_question: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§π‡•à‡§Ç?",
        delete_account_confirm_description: "‡§Ø‡§π ‡§Ü‡§™‡§ï‡•á ‡§ñ‡§æ‡§§‡•á ‡§ï‡•ã ‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§π‡§ü‡§æ ‡§Ø‡§æ ‡§Ö‡§ï‡•ç‡§∑‡§Æ ‡§ï‡§∞ ‡§¶‡•á‡§ó‡§æ‡•§",
        confirm_delete: "‡§π‡§æ‡§Å, ‡§Æ‡•á‡§∞‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§π‡§ü‡§æ‡§è‡§Å",
        cancel_delete: "‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
        // ...add more as needed
      }
    };

    // --- TRANSLATION FUNCTION ---
    function applyTranslations(lang) {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
          el.textContent = translations[lang][key];
        }
      });
    }

    // Initialize the application
    class AdminDashboard {
      constructor() {
        this.currentSection = 'dashboard';
        this.token = localStorage.getItem('token');
        this.init();
      }

      async init() {
        this.setupEventListeners();
        await this.loadAdminInfo();
        this.loadDashboardStats();
        
        // Auto-refresh dashboard stats every 30 seconds
        setInterval(() => {
          if (this.currentSection === 'dashboard') {
            this.loadDashboardStats();
          }
        }, 30000);
      }

      setupEventListeners() {
        // Navigation links
        document.querySelectorAll('.nav-link').forEach(link => {
          link.addEventListener('click', (e) => {
            e.preventDefault();
            const section = e.currentTarget.dataset.section;
            this.switchSection(section);
          });
        });

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
          e.preventDefault();
          this.logout();
        });

        // Mobile sidebar toggle
        document.getElementById('sidebarToggle').addEventListener('click', () => {
          document.getElementById('sidebar').classList.toggle('active');
          document.getElementById('sidebarToggle').classList.toggle('active'); // Toggle active class on button
          document.getElementById('sidebarOverlay').classList.toggle('active'); // Toggle overlay
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
          if (window.innerWidth <= 768) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebarToggle');
            const overlay = document.getElementById('sidebarOverlay');
            if (!sidebar.contains(e.target) && !toggle.contains(e.target) && (!overlay || !overlay.contains(e.target))) {
              sidebar.classList.remove('active');
              toggle.classList.remove('active');
              overlay.classList.remove('active');
            }
          }
        });

        // Manage Login submenu toggle
        document.getElementById('manageLoginMenu').addEventListener('click', function(e) {
          e.preventDefault();
          // Close other submenus if any
          document.querySelectorAll('.submenu').forEach(sm => { if (sm !== document.getElementById('manageLoginSubmenu')) sm.style.display = 'none'; });
          const submenu = document.getElementById('manageLoginSubmenu');
          submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
          // Always show Manage Login section and default to 'All' data
          dashboard.switchSection('manageLogin');
          dashboard.setActiveManageLoginSubmenu('ALL');
        });
        // All submenu click
        document.querySelector('[data-section="manageLoginAll"]').addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('manageLoginSubmenu').style.display = 'block';
          dashboard.switchSection('manageLogin');
          dashboard.setActiveManageLoginSubmenu('ALL');
        });
        // Teachers submenu click
        document.querySelector('[data-section="manageLoginTeachers"]').addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('manageLoginSubmenu').style.display = 'block';
          dashboard.switchSection('manageLogin');
          dashboard.setActiveManageLoginSubmenu('TEACHER');
        });
        // Students submenu click
        document.querySelector('[data-section="manageLoginStudents"]').addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('manageLoginSubmenu').style.display = 'block';
          dashboard.switchSection('manageLogin');
          dashboard.setActiveManageLoginSubmenu('STUDENT');
        });

        // Settings submenu toggle
        document.getElementById('settingsMenu').addEventListener('click', function(e) {
          e.preventDefault();
          // Close other submenus if any
          document.querySelectorAll('.submenu').forEach(sm => { if (sm !== document.getElementById('settingsSubmenu')) sm.style.display = 'none'; });
          const submenu = document.getElementById('settingsSubmenu');
          submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
          // Always show Settings section and default to Profile tab
          dashboard.switchSection('settings');
          dashboard.setActiveSettingsTab('profile');
        });
        // Settings submenu item click
        document.querySelectorAll('#settingsSubmenu [data-settings-tab]').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('settingsSubmenu').style.display = 'block';
            dashboard.switchSection('settings');
            dashboard.setActiveSettingsTab(this.getAttribute('data-settings-tab'));
          });
        });

        // Helper to show loading/error in Manage Login table
        this.showManageLoginLoadingOrError = function() {
          const tableDiv = document.getElementById('manageLoginTable');
          tableDiv.innerHTML = `<div class='empty-state'><i class='fas fa-spinner loading-spinner'></i><h5>Loading users...</h5><p>Please wait while we fetch the user data.</p></div>`;
        };
      }

      switchSection(section) {
        // Update navigation
        document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.remove('active');
        });
        const sectionEl = document.querySelector(`[data-section="${section}"]`);
        if (sectionEl) sectionEl.classList.add('active');
        let sectionDiv = document.getElementById(`${section}Section`);
        if (sectionDiv)
          sectionDiv.style.display = 'block';

        // Hide all sections
        document.querySelectorAll('.content-section').forEach(sectionEl => {
          sectionEl.style.display = 'none';
        });

        // Show selected section
        sectionDiv = document.getElementById(`${section}Section`);
        if (sectionDiv)
          sectionDiv.style.display = 'block';

        // Load section-specific data
        switch(section) {
          case 'students':
            this.loadStudents();
            break;
          case 'teachers':
            this.loadTeachers();
            break;
          case 'manageLogin':
            this.loadManageLogin();
            break;
          case 'dashboard':
            this.loadDashboardStats();
            break;
        }

        this.currentSection = section;
      }

      async loadAdminInfo() {
        if (this.token) {
          try {
            // First try to get name from token
            const payload = JSON.parse(atob(this.token.split('.')[1]));
            console.log('Token payload:', payload);
            console.log('User ID:', payload.id);
            console.log('Admin Type:', payload.adminType);
            
            // Try to fetch actual user data from server
            const response = await fetch('/api/admin/me', {
              headers: { 'Authorization': 'Bearer ' + this.token }
            });
            
            if (response.ok) {
              const userData = await response.json();
              document.getElementById('adminName').textContent = userData.fullName || 'Admin';
              console.log('User data from server:', userData);
            } else {
              // Fallback to token data
              document.getElementById('adminName').textContent = payload.fullName || 'Admin';
            }
          } catch (e) {
            console.error('Error loading admin info:', e);
            document.getElementById('adminName').textContent = 'Admin';
          }
        } else {
          console.error('No token found in localStorage');
          document.getElementById('adminName').textContent = 'Admin';
        }
      }

      async loadDashboardStats() {
        if (!this.token) {
          console.error('No authentication token found');
          return;
        }

        try {
          const response = await fetch('/api/admin/stats', {
            headers: { 'Authorization': 'Bearer ' + this.token }
          });
          
          if (response.ok) {
            const stats = await response.json();
            
            document.getElementById('totalStudents').textContent = stats.totalStudents;
            document.getElementById('totalTeachers').textContent = stats.totalTeachers;
            document.getElementById('pendingRequests').textContent = stats.pendingRequests;
            document.getElementById('approvedUsers').textContent = stats.approvedUsers;
          } else {
            const errorData = await response.json();
            console.error('Failed to load dashboard stats:', errorData);
            
            // Show error message in dashboard
            const dashboardContent = document.querySelector('#dashboardSection .section-body');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'custom-alert danger';
            errorDiv.innerHTML = `
              <h5><i class="fas fa-exclamation-triangle me-2"></i>Error Loading Dashboard Data</h5>
              <p>${errorData.message || 'Failed to load dashboard statistics.'}</p>
              <small class="text-muted">Please check your login status and permissions.</small>
            `;
            dashboardContent.appendChild(errorDiv);
            
            // Set default values
            document.getElementById('totalStudents').textContent = '0';
            document.getElementById('totalTeachers').textContent = '0';
            document.getElementById('pendingRequests').textContent = '0';
            document.getElementById('approvedUsers').textContent = '0';
          }
        } catch (error) {
          console.error('Error loading dashboard stats:', error);
          // Set default values if API fails
          document.getElementById('totalStudents').textContent = '0';
          document.getElementById('totalTeachers').textContent = '0';
          document.getElementById('pendingRequests').textContent = '0';
          document.getElementById('approvedUsers').textContent = '0';
        }
      }

      async loadStudents() {
        const tableDiv = document.getElementById('studentsTable');
        
        if (!this.token) {
          tableDiv.innerHTML = `
            <div class="custom-alert danger">
              <h5><i class="fas fa-exclamation-triangle me-2"></i>Authentication Required</h5>
              <p>Please log in to view student data.</p>
            </div>
          `;
          return;
        }

        tableDiv.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-spinner loading-spinner"></i>
            <h5>Loading students...</h5>
            <p>Please wait while we fetch the student data.</p>
          </div>
        `;

        try {
          const response = await fetch('/api/admin/all', {
            headers: { 'Authorization': 'Bearer ' + this.token }
          });
          
          const data = await response.json();
          
          if (response.ok && Array.isArray(data)) {
            this.displayStudents(data);
          } else {
            throw new Error(data.message || 'Failed to load students');
          }
        } catch (error) {
          console.error('Error loading students:', error);
          tableDiv.innerHTML = `
            <div class="custom-alert danger">
              <h5><i class="fas fa-exclamation-triangle me-2"></i>Error Loading Students</h5>
              <p>${error.message}</p>
              <small class="text-muted">Please check your login status and try again.</small>
            </div>
          `;
        }
      }

      displayStudents(students) {
        const tableDiv = document.getElementById('studentsTable');
        const countDiv = document.getElementById('studentCount');
        
        countDiv.textContent = `${students.length} student${students.length !== 1 ? 's' : ''}`;

        if (students.length === 0) {
          tableDiv.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-user-graduate"></i>
              <h5>No Students Found</h5>
              <p>There are no approved students in the system yet.</p>
            </div>
          `;
          return;
        }

        let html = `
          <div class="table-container">
            <table class="custom-table">
              <thead>
                <tr>
                  <th>Photo</th>
                  <th>Name</th>
                  <th>Roll No</th>
                  <th>Email</th>
                  <th>Mobile</th>
                  <th>Date of Birth</th>
                  <th>Gender</th>
                  <th>Address</th>
                </tr>
              </thead>
              <tbody>
        `;

        students.forEach(student => {
          const photoUrl = student.photo ? `/uploads/${student.photo}` : '/uploads/default.png';
          const dob = student.dob ? new Date(student.dob).toLocaleDateString() : '-';
          
          html += `
            <tr>
              <td>
                <img src="${photoUrl}" alt="${student.fullName}" class="student-photo" 
                     onerror="this.src='/uploads/default.png'">
              </td>
              <td><strong>${student.fullName}</strong></td>
              <td>${student.rollNo || '-'}</td>
              <td>${student.email}</td>
              <td>${student.mobile}</td>
              <td>${dob}</td>
              <td>${student.gender || '-'}</td>
              <td>${student.address || '-'}</td>
            </tr>
          `;
        });

        html += '</tbody></table></div>';
        tableDiv.innerHTML = html;
      }

      async loadTeachers() {
        const tableDiv = document.getElementById('teachersTable');
        
        if (!this.token) {
          tableDiv.innerHTML = `
            <div class="custom-alert danger">
              <h5><i class="fas fa-exclamation-triangle me-2"></i>Authentication Required</h5>
              <p>Please log in to view teacher data.</p>
            </div>
          `;
          return;
        }

        tableDiv.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-spinner loading-spinner"></i>
            <h5>Loading teachers...</h5>
            <p>Please wait while we fetch the teacher data.</p>
          </div>
        `;

        try {
          const response = await fetch('/api/admin/teachers', {
            headers: { 'Authorization': 'Bearer ' + this.token }
          });
          
          const data = await response.json();
          
          if (response.ok && Array.isArray(data)) {
            this.displayTeachers(data);
          } else {
            throw new Error(data.message || 'Failed to load teachers');
          }
        } catch (error) {
          tableDiv.innerHTML = `
            <div class="custom-alert danger">
              <h5><i class="fas fa-exclamation-triangle me-2"></i>Error Loading Teachers</h5>
              <p>${error.message}</p>
            </div>
          `;
        }
      }

      displayTeachers(teachers) {
        const tableDiv = document.getElementById('teachersTable');
        const countDiv = document.getElementById('teacherCount');
        
        countDiv.textContent = `${teachers.length} teacher${teachers.length !== 1 ? 's' : ''}`;

        if (teachers.length === 0) {
          tableDiv.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-chalkboard-teacher"></i>
              <h5>No Teachers Found</h5>
              <p>There are no approved teachers in the system yet.</p>
            </div>
          `;
          return;
        }

        let html = `
          <div class="table-container">
            <table class="custom-table">
              <thead>
                <tr>
                  <th>Photo</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Mobile</th>
                  <th>Date of Birth</th>
                  <th>Gender</th>
                  <th>Address</th>
                </tr>
              </thead>
              <tbody>
        `;

        teachers.forEach(teacher => {
          const photoUrl = teacher.photo ? `/uploads/${teacher.photo}` : '/uploads/default.png';
          const dob = teacher.dob ? new Date(teacher.dob).toLocaleDateString() : '-';
          
          html += `
            <tr>
              <td>
                <img src="${photoUrl}" alt="${teacher.fullName}" class="student-photo" 
                     onerror="this.src='/uploads/default.png'">
              </td>
              <td><strong>${teacher.fullName}</strong></td>
              <td>${teacher.email}</td>
              <td>${teacher.mobile}</td>
              <td>${dob}</td>
              <td>${teacher.gender || '-'}</td>
              <td>${teacher.address || '-'}</td>
            </tr>
          `;
        });

        html += '</tbody></table></div>';
        tableDiv.innerHTML = html;
      }

      setActiveManageLoginSubmenu(type) {
        // Highlight active submenu
        const allLink = document.querySelector('[data-section="manageLoginAll"]');
        const teacherLink = document.querySelector('[data-section="manageLoginTeachers"]');
        const studentLink = document.querySelector('[data-section="manageLoginStudents"]');
        allLink.classList.remove('active');
        teacherLink.classList.remove('active');
        studentLink.classList.remove('active');
        if (type === 'ALL') allLink.classList.add('active');
        else if (type === 'TEACHER') teacherLink.classList.add('active');
        else if (type === 'STUDENT') studentLink.classList.add('active');
        this.currentManageLoginTab = type;
        if (this.manageLoginUsers && Array.isArray(this.manageLoginUsers)) {
          if (type === 'ALL') {
            this.displayManageLogin(this.manageLoginUsers.filter(u => u.adminType === 'TEACHER' || u.adminType === 'STUDENT'));
          } else {
            this.displayManageLogin(this.manageLoginUsers.filter(u => u.adminType === type));
          }
        } else {
          this.showManageLoginLoadingOrError();
        }
      }

      async loadManageLogin() {
        const tableDiv = document.getElementById('manageLoginTable');
        // Check role before loading
        if (typeof isAdminOrSuperAdmin === 'function' && !isAdminOrSuperAdmin()) {
          tableDiv.innerHTML = `<div class='custom-alert danger'>You do not have permission to manage logins. Only Admin or Super Admin can access this section.</div>`;
          return;
        }
        tableDiv.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-spinner loading-spinner"></i>
            <h5>Loading users...</h5>
            <p>Please wait while we fetch the user data.</p>
          </div>
        `;
        try {
          const response = await fetch('/api/admin/users', {
            headers: { 'Authorization': 'Bearer ' + this.token }
          });
          const data = await response.json();
          if (response.status === 403) {
            tableDiv.innerHTML = `<div class='custom-alert danger'>${data.message || 'You do not have permission to view this data.'}</div>`;
            return;
          }
          if (response.ok && Array.isArray(data)) {
            this.manageLoginUsers = data; // cache for tab switching
            // Default: show ALL if coming from main menu, else keep current
            if (!this.currentManageLoginTab) this.currentManageLoginTab = 'ALL';
            this.setActiveManageLoginSubmenu(this.currentManageLoginTab);
          } else {
            throw new Error(data.message || 'Failed to load users');
          }
        } catch (error) {
          tableDiv.innerHTML = `<div class='custom-alert danger'>${error.message}</div>`;
        }
      }

      displayManageLogin(users) {
        const tableDiv = document.getElementById('manageLoginTable');
        if (!users.length) {
          tableDiv.innerHTML = `<div class='empty-state'><i class='fas fa-users'></i><h5>No Teachers or Students Found</h5></div>`;
          return;
        }
        let html = `
          <div class="table-container">
            <table class="custom-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Mobile</th>
                  <th>Role</th>
                  <th>Password</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
        `;
        users.forEach(user => {
          html += `
            <tr id="user-row-${user._id}">
              <td><span class="user-name">${user.fullName}</span><input type="text" class="form-control d-none" value="${user.fullName}" /></td>
              <td><span class="user-email">${user.email}</span><input type="email" class="form-control d-none" value="${user.email}" /></td>
              <td><span class="user-mobile">${user.mobile}</span><input type="text" class="form-control d-none" value="${user.mobile}" /></td>
              <td>${user.adminType}</td>
              <td><span class="user-password">******</span><input type="password" class="form-control d-none" placeholder="New Password (leave blank to keep)" /></td>
              <td>
                <button class="btn btn-sm btn-primary edit-btn"><i class="fas fa-edit"></i> Edit</button>
                <button class="btn btn-sm btn-success save-btn d-none"><i class="fas fa-save"></i> Save</button>
                <button class="btn btn-sm btn-secondary cancel-btn d-none"><i class="fas fa-times"></i> Cancel</button>
              </td>
            </tr>
          `;
        });
        html += '</tbody></table></div>';
        tableDiv.innerHTML = html;
        // Add event listeners for edit/save/cancel
        users.forEach(user => {
          const row = document.getElementById(`user-row-${user._id}`);
          const editBtn = row.querySelector('.edit-btn');
          const saveBtn = row.querySelector('.save-btn');
          const cancelBtn = row.querySelector('.cancel-btn');
          const spans = row.querySelectorAll('span');
          const inputs = row.querySelectorAll('input');
          editBtn.addEventListener('click', () => {
            spans.forEach(s => s.classList.add('d-none'));
            inputs.forEach(i => i.classList.remove('d-none'));
            editBtn.classList.add('d-none');
            saveBtn.classList.remove('d-none');
            cancelBtn.classList.remove('d-none');
          });
          cancelBtn.addEventListener('click', () => {
            spans.forEach((s, idx) => { s.classList.remove('d-none'); if(inputs[idx]) inputs[idx].classList.add('d-none'); });
            inputs[3].value = '';
            editBtn.classList.remove('d-none');
            saveBtn.classList.add('d-none');
            cancelBtn.classList.add('d-none');
          });
          saveBtn.addEventListener('click', async () => {
            const fullName = inputs[0].value.trim();
            const email = inputs[1].value.trim();
            const mobile = inputs[2].value.trim();
            const password = inputs[3].value.trim();
            saveBtn.disabled = true;
            try {
              const res = await fetch(`/api/admin/update/${user._id}`, {
                method: 'PUT',
                headers: {
                  'Authorization': 'Bearer ' + this.token,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ fullName, email, mobile, password })
              });
              const data = await res.json();
              if (res.ok) {
                spans[0].textContent = fullName;
                spans[1].textContent = email;
                spans[2].textContent = mobile;
                inputs[3].value = '';
                document.getElementById('manageLoginMsg').innerHTML = `<div class='custom-alert success'>${data.message}</div>`;
                cancelBtn.click();
              } else {
                document.getElementById('manageLoginMsg').innerHTML = `<div class='custom-alert danger'>${data.message || 'Update failed.'}</div>`;
              }
            } catch (err) {
              document.getElementById('manageLoginMsg').innerHTML = `<div class='custom-alert danger'>Network error. Please try again.</div>`;
            }
            saveBtn.disabled = false;
          });
        });
      }

      async testAuth() {
        if (!this.token) {
          alert('No authentication token found!');
          return;
        }

        try {
          const response = await fetch('/api/admin/test-auth', {
            headers: { 'Authorization': 'Bearer ' + this.token }
          });
          
          const data = await response.json();
          
          if (response.ok) {
            alert(`Authentication Test Successful!\n\nUser: ${data.user.fullName}\nEmail: ${data.user.email}\nType: ${data.user.adminType}\nApproved: ${data.user.isApproved ? 'Yes' : 'No'}`);
          } else {
            alert(`Authentication Test Failed!\n\nError: ${data.message}\n\nPlease check your login status.`);
          }
        } catch (error) {
          console.error('Auth test error:', error);
          alert('Authentication test failed. Check console for details.');
        }
      }

      logout() {
        localStorage.removeItem('token');
        window.location.href = '/auth/login.html';
      }

      setActiveSettingsTab(tab) {
        // Highlight active submenu
        document.querySelectorAll('#settingsSubmenu [data-settings-tab]').forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('data-settings-tab') === tab) link.classList.add('active');
        });
        // Show only the selected tab content
        document.querySelectorAll('.settings-tab-pane').forEach(pane => {
          pane.style.display = 'none';
        });
        const tabPane = document.getElementById(`${tab}Tab`);
        if (tabPane) tabPane.style.display = 'block';
      }
    }

    // Initialize dashboard when page loads
    let dashboard;
    document.addEventListener('DOMContentLoaded', () => {
      dashboard = new AdminDashboard();
      // Initialize overlay
      document.getElementById('sidebarOverlay').classList.remove('active'); // Ensure it's not active on load

      // Settings Panel Button Functionality
      // Only one DOMContentLoaded for profile logic
      (function() {
        let originalProfile = {};
        function setProfileEditable(editable) {
          document.getElementById('profileName').readOnly = !editable;
          document.getElementById('profileEmail').readOnly = !editable;
          document.getElementById('profileMobile').readOnly = !editable;
          document.getElementById('profilePhotoInput').disabled = !editable;
          document.getElementById('editProfileBtn').classList.toggle('d-none', editable);
          document.getElementById('saveProfileBtn').classList.toggle('d-none', !editable);
          document.getElementById('cancelProfileBtn').classList.toggle('d-none', !editable);
        }
        function loadProfileData() {
          const token = localStorage.getItem('token');
          if (!token) return;
          fetch('/api/admin/me', {
            headers: { 'Authorization': 'Bearer ' + token }
          })
          .then(res => res.json())
          .then(data => {
            if (data && data.fullName) {
              document.getElementById('profileName').value = data.fullName || '';
              document.getElementById('profileEmail').value = data.email || '';
              document.getElementById('profileMobile').value = data.mobile || '';
              document.getElementById('profilePhotoPreview').src = data.photo ? `/uploads/${data.photo}` : '/uploads/default.png';
              originalProfile = {
                fullName: data.fullName || '',
                email: data.email || '',
                mobile: data.mobile || '',
                photo: data.photo || ''
              };
              setProfileEditable(false);
            }
          });
        }
        document.getElementById('editProfileBtn').onclick = function() {
          setProfileEditable(true);
        };
        document.getElementById('cancelProfileBtn').onclick = function() {
          document.getElementById('profileName').value = originalProfile.fullName;
          document.getElementById('profileEmail').value = originalProfile.email;
          document.getElementById('profileMobile').value = originalProfile.mobile;
          document.getElementById('profilePhotoPreview').src = originalProfile.photo ? `/uploads/${originalProfile.photo}` : '/uploads/default.png';
          document.getElementById('profilePhotoInput').value = '';
          setProfileEditable(false);
          document.getElementById('profileMsg').innerHTML = '';
        };
        document.getElementById('saveProfileBtn').onclick = async function() {
          const fullName = document.getElementById('profileName').value.trim();
          const email = document.getElementById('profileEmail').value.trim();
          const mobile = document.getElementById('profileMobile').value.trim();
          const photoInput = document.getElementById('profilePhotoInput');
          const token = localStorage.getItem('token');
          let userId = null;
          if (token) {
            try {
              const payload = JSON.parse(atob(token.split('.')[1]));
              userId = payload.id;
            } catch {}
          }
          if (!userId) {
            document.getElementById('profileMsg').innerHTML = '<div class="alert alert-danger">User not authenticated.</div>';
            return;
          }
          try {
            const formData = new FormData();
            formData.append('fullName', fullName);
            formData.append('email', email);
            formData.append('mobile', mobile);
            if (photoInput.files && photoInput.files[0]) {
              formData.append('photo', photoInput.files[0]);
            }
            const res = await fetch(`/api/admin/update/${userId}`, {
              method: 'PUT',
              headers: {
                'Authorization': 'Bearer ' + token
              },
              body: formData
            });
            const data = await res.json();
            if (res.ok) {
              document.getElementById('profileMsg').innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
              window.alert('Profile data has been updated.');
              if (data.user && data.user.photo) {
                document.getElementById('profilePhotoPreview').src = `/uploads/${data.user.photo}`;
                originalProfile.photo = data.user.photo;
              }
              originalProfile.fullName = fullName;
              originalProfile.email = email;
              originalProfile.mobile = mobile;
              setProfileEditable(false);
            } else {
              document.getElementById('profileMsg').innerHTML = '<div class="alert alert-danger">' + (data.message || 'Failed to update profile.') + '</div>';
            }
          } catch (err) {
            document.getElementById('profileMsg').innerHTML = '<div class="alert alert-danger">Network error. Please try again.</div>';
          }
        };
        document.getElementById('profilePhotoInput').addEventListener('change', function() {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
              document.getElementById('profilePhotoPreview').src = e.target.result;
            };
            reader.readAsDataURL(this.files[0]);
          }
        });
        // Ensure profile loads on tab show
        dashboard.setActiveSettingsTab = function(tab) {
          document.querySelectorAll('#settingsSubmenu [data-settings-tab]').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-settings-tab') === tab) link.classList.add('active');
          });
          document.querySelectorAll('.settings-tab-pane').forEach(pane => {
            pane.style.display = 'none';
          });
          const tabPane = document.getElementById(`${tab}Tab`);
          if (tabPane) tabPane.style.display = 'block';
          if (tab === 'profile') loadProfileData();
        };
      })();

      // Profile data loader
      function loadProfileData() {
        const token = localStorage.getItem('token');
        if (!token) return;
        fetch('/api/admin/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(res => res.json())
        .then(data => {
          if (data && data.fullName) {
            document.getElementById('profileName').value = data.fullName || '';
            document.getElementById('profileEmail').value = data.email || '';
            document.getElementById('profileMobile').value = data.mobile || '';
            document.getElementById('profilePhotoPreview').src = data.photo ? `/uploads/${data.photo}` : '/uploads/default.png';
          }
        });
      }

      // Assign setActiveSettingsTab after dashboard is defined
      dashboard.setActiveSettingsTab = function(tab) {
        // Highlight active submenu
        document.querySelectorAll('#settingsSubmenu [data-settings-tab]').forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('data-settings-tab') === tab) link.classList.add('active');
        });
        // Show only the selected tab content
        document.querySelectorAll('.settings-tab-pane').forEach(pane => {
          pane.style.display = 'none';
        });
        const tabPane = document.getElementById(`${tab}Tab`);
        if (tabPane) tabPane.style.display = 'block';
        // Load profile data if profile tab
        if (tab === 'profile') loadProfileData();
      };

      // Theme (Dark Mode) toggle persistence
      (function() {
        const darkModeToggle = document.getElementById('darkModeToggle');
        // Apply theme on load
        if (localStorage.getItem('theme') === 'dark') {
          document.body.classList.add('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = true;
        } else {
          document.body.classList.remove('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = false;
        }
        // Toggle event
        if (darkModeToggle) {
          darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
              document.body.classList.add('dark-mode');
              localStorage.setItem('theme', 'dark');
            } else {
              document.body.classList.remove('dark-mode');
              localStorage.setItem('theme', 'light');
            }
          });
        }
      })();

      // Sidebar Collapse toggle persistence
      (function() {
        const sidebarCollapseToggle = document.getElementById('sidebarCollapseToggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.querySelector('.main-content');
        // Apply collapse state on load
        if (localStorage.getItem('sidebar') === 'collapsed') {
          sidebar.classList.add('collapsed');
          if (mainContent) mainContent.classList.add('sidebar-collapsed');
          if (sidebarCollapseToggle) sidebarCollapseToggle.checked = true;
        } else {
          sidebar.classList.remove('collapsed');
          if (mainContent) mainContent.classList.remove('sidebar-collapsed');
          if (sidebarCollapseToggle) sidebarCollapseToggle.checked = false;
        }
        // Toggle event
        if (sidebarCollapseToggle) {
          sidebarCollapseToggle.addEventListener('change', function() {
            if (this.checked) {
              sidebar.classList.add('collapsed');
              if (mainContent) mainContent.classList.add('sidebar-collapsed');
              localStorage.setItem('sidebar', 'collapsed');
            } else {
              sidebar.classList.remove('collapsed');
              if (mainContent) mainContent.classList.remove('sidebar-collapsed');
              localStorage.setItem('sidebar', 'expanded');
            }
          });
        }
      })();

      // Language Preference persistence
      (function() {
        const languageSelect = document.getElementById('languageSelect');
        if (languageSelect) {
          // On load
          const lang = localStorage.getItem('language') || 'en';
          applyTranslations(lang);

          // On change
          languageSelect.addEventListener('change', function() {
            localStorage.setItem('language', this.value);
            applyTranslations(this.value);
          });
        }
      })();
    });

    // 2FA Frontend Logic
    (function() {
      const enable2FA = document.getElementById('enable2FA');
      const twoFAModal = new bootstrap.Modal(document.getElementById('twoFAModal'));
      let qrImg = null;
      if (enable2FA) {
        enable2FA.disabled = false;
        enable2FA.addEventListener('change', async function() {
          if (this.checked) {
            // Start 2FA setup
            document.getElementById('twoFAMsg').innerHTML = '';
            document.getElementById('twoFACodeInput').value = '';
            document.getElementById('twoFAQrSection').innerHTML = '<div class="text-muted">Loading QR code...</div>';
            twoFAModal.show();
            // Fetch QR code from backend
            const token = localStorage.getItem('token');
            const res = await fetch('/api/admin/2fa/setup', {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            if (res.ok && data.qr) {
              document.getElementById('twoFAQrSection').innerHTML = `<img src='${data.qr}' alt='2FA QR' style='width:180px;height:180px;'>`;
            } else {
              document.getElementById('twoFAQrSection').innerHTML = '<div class="text-danger">Failed to load QR code.</div>';
            }
          } else {
            // Disable 2FA
            if (confirm('Are you sure you want to disable 2FA?')) {
              const token = localStorage.getItem('token');
              const res = await fetch('/api/admin/2fa/disable', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
              });
              const data = await res.json();
              if (res.ok) {
                alert('2FA disabled.');
              } else {
                alert(data.message || 'Failed to disable 2FA.');
                enable2FA.checked = true;
              }
            } else {
              enable2FA.checked = true;
            }
          }
        });
        // Verify 2FA code
        document.getElementById('verify2FABtn').onclick = async function() {
          const code = document.getElementById('twoFACodeInput').value.trim();
          if (!/^[0-9]{6}$/.test(code)) {
            document.getElementById('twoFAMsg').innerHTML = '<div class="text-danger">Enter a valid 6-digit code.</div>';
            return;
          }
          const token = localStorage.getItem('token');
          const res = await fetch('/api/admin/2fa/verify', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token: code })
          });
          const data = await res.json();
          if (res.ok) {
            document.getElementById('twoFAMsg').innerHTML = '<div class="text-success">2FA enabled successfully!</div>';
            setTimeout(() => { twoFAModal.hide(); }, 1000);
          } else {
            document.getElementById('twoFAMsg').innerHTML = `<div class="text-danger">${data.message || 'Invalid code.'}</div>`;
          }
        };
      }
    })();

    // User Management Logic (Teachers/Students tabs, only approved)
    (function() {
      const usersTableContainer = document.getElementById('usersTableContainer');
      const addUserBtn = document.getElementById('addUserBtn');
      const exportUsersBtn = document.getElementById('exportUsersBtn');
      const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
      const userTypeTabs = document.getElementById('userTypeTabs');
      let users = [];
      let selectedUserIds = new Set();
      let userModal = new bootstrap.Modal(document.getElementById('userModal'));
      let currentType = 'TEACHER';
      // Fetch and render users
      async function loadUsers() {
        usersTableContainer.innerHTML = `<div class='empty-state'><i class='fas fa-spinner loading-spinner'></i><h5>Loading users...</h5></div>`;
        const token = localStorage.getItem('token');
        const res = await fetch(`/api/admin/users?role=${currentType}&status=active`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        users = await res.json();
        renderUsersTable();
      }
      function renderUsersTable() {
        if (!Array.isArray(users) || users.length === 0) {
          usersTableContainer.innerHTML = `<div class='empty-state'><i class='fas fa-users'></i><h5>No users found.</h5></div>`;
          return;
        }
        let html = `<table class='custom-table'><thead><tr>
          <th><input type='checkbox' id='selectAllUsers'></th>
          <th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
        users.forEach(user => {
          const isActive = user.isApproved !== false && user.status !== 'inactive';
          html += `<tr>
            <td><input type='checkbox' class='userCheckbox' data-id='${user._id}' ${selectedUserIds.has(user._id) ? 'checked' : ''}></td>
            <td>${user.fullName}</td>
            <td>${user.email}</td>
            <td>${user.adminType}</td>
            <td><span class='badge ${isActive ? 'bg-success' : 'bg-secondary'}'>${isActive ? 'Active' : 'Inactive'}</span></td>
            <td>
              <button class='btn btn-sm btn-primary editUserBtn' data-id='${user._id}'><i class='fas fa-edit'></i></button>
              <button class='btn btn-sm ${isActive ? 'btn-success' : 'btn-secondary'} statusUserBtn' data-id='${user._id}' data-status='${isActive ? 'active' : 'inactive'}' title='${isActive ? 'Deactivate' : 'Activate'}'>
                <i class='fas fa-toggle-${isActive ? 'on' : 'off'}'></i>
              </button>
              <button class='btn btn-sm btn-danger deleteUserBtn' data-id='${user._id}'><i class='fas fa-trash'></i></button>
            </td>
          </tr>`;
        });
        html += '</tbody></table>';
        usersTableContainer.innerHTML = html;
        // Event listeners
        document.getElementById('selectAllUsers').onchange = function() {
          document.querySelectorAll('.userCheckbox').forEach(cb => {
            cb.checked = this.checked;
            if (this.checked) selectedUserIds.add(cb.dataset.id);
            else selectedUserIds.delete(cb.dataset.id);
          });
          updateBulkDeleteBtn();
        };
        document.querySelectorAll('.userCheckbox').forEach(cb => {
          cb.onchange = function() {
            if (this.checked) selectedUserIds.add(this.dataset.id);
            else selectedUserIds.delete(this.dataset.id);
            updateBulkDeleteBtn();
          };
        });
        document.querySelectorAll('.editUserBtn').forEach(btn => {
          btn.onclick = () => openUserModal(btn.dataset.id);
        });
        document.querySelectorAll('.deleteUserBtn').forEach(btn => {
          btn.onclick = () => deleteUser(btn.dataset.id);
        });
        // Status toggle event
        document.querySelectorAll('.statusUserBtn').forEach(btn => {
          btn.onclick = async function() {
            const id = btn.dataset.id;
            const user = users.find(u => u._id === id);
            if (!user) return;
            const token = localStorage.getItem('token');
            const newStatus = !(user.isApproved !== false && user.status !== 'inactive');
            await fetch(`/api/admin/users/${id}/status`, {
              method: 'PATCH',
              headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
              body: JSON.stringify({ isApproved: newStatus })
            });
            loadUsers();
          };
        });
        updateBulkDeleteBtn();
      }
      function updateBulkDeleteBtn() {
        bulkDeleteBtn.disabled = selectedUserIds.size === 0;
      }
      // Add User
      addUserBtn.onclick = () => openUserModal();
      // Export Users
      exportUsersBtn.onclick = () => {
        const token = localStorage.getItem('token');
        let url = `/api/admin/users/export?token=${token}&role=${currentType}&status=active`;
        if (selectedUserIds.size > 0) {
          url += '&ids=' + Array.from(selectedUserIds).join(',');
        }
        window.open(url, '_blank');
      };
      // Bulk Delete
      bulkDeleteBtn.onclick = async () => {
        if (!confirm('Delete selected users?')) return;
        const token = localStorage.getItem('token');
        await fetch('/api/admin/users/bulk', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids: Array.from(selectedUserIds), action: 'delete' })
        });
        selectedUserIds.clear();
        loadUsers();
      };
      // Tab switching
      userTypeTabs.querySelectorAll('.nav-link').forEach(tab => {
        tab.onclick = function(e) {
          e.preventDefault();
          userTypeTabs.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          currentType = this.getAttribute('data-type');
          selectedUserIds.clear();
          loadUsers();
        };
      });
      // Open Add/Edit Modal
      function openUserModal(id) {
        document.getElementById('userForm').reset();
        document.getElementById('userIdInput').value = '';
        document.getElementById('userPasswordHelp').style.display = 'block';
        if (id) {
          const user = users.find(u => u._id === id);
          if (!user) return;
          document.getElementById('userModalLabel').textContent = 'Edit User';
          document.getElementById('userIdInput').value = user._id;
          document.getElementById('userFullNameInput').value = user.fullName;
          document.getElementById('userEmailInput').value = user.email;
          document.getElementById('userMobileInput').value = user.mobile || '';
          document.getElementById('userRoleInput').value = user.adminType;
          document.getElementById('userStatusInput').value = 'active';
          document.getElementById('userPasswordHelp').style.display = 'block';
        } else {
          document.getElementById('userModalLabel').textContent = 'Add User';
          document.getElementById('userPasswordHelp').style.display = 'none';
          document.getElementById('userRoleInput').value = currentType;
          document.getElementById('userStatusInput').value = 'active';
        }
        userModal.show();
      }
      // Save User
      document.getElementById('userForm').onsubmit = async function(e) {
        e.preventDefault();
        const id = document.getElementById('userIdInput').value;
        const fullName = document.getElementById('userFullNameInput').value.trim();
        const email = document.getElementById('userEmailInput').value.trim();
        const mobile = document.getElementById('userMobileInput').value.trim();
        const adminType = document.getElementById('userRoleInput').value;
        const isApproved = true;
        const password = document.getElementById('userPasswordInput').value;
        const token = localStorage.getItem('token');
        const body = { fullName, email, mobile, adminType, isApproved };
        if (password) body.password = password;
        let res;
        if (id) {
          res = await fetch(`/api/admin/users/${id}`, {
            method: 'PUT',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
        } else {
          body.password = password || Math.random().toString(36).slice(-8);
          res = await fetch('/api/admin/users', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
        }
        if (res.ok) {
          userModal.hide();
          loadUsers();
        } else {
          alert('Failed to save user.');
        }
      };
      // Delete User
      async function deleteUser(id) {
        if (!confirm('Delete this user?')) return;
        const token = localStorage.getItem('token');
        await fetch(`/api/admin/users/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        loadUsers();
      }
      // Initial load
      loadUsers();
    })();

    // Load pending requests
    async function loadPendingRequests() {
      const token = localStorage.getItem('token');
      const res = await fetch('/api/admin/users?status=pending', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      const users = await res.json();
      renderPendingRequestsTable(users);
    }

    function renderPendingRequestsTable(users) {
      let html = '<table class="custom-table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead><tbody>';
      users.forEach(user => {
        html += `<tr>
          <td>${user.fullName}</td>
          <td>${user.email}</td>
          <td>${user.adminType}</td>
          <td>
            <button class="btn btn-success btn-sm acceptBtn" data-id="${user._id}">Accept</button>
            <button class="btn btn-danger btn-sm rejectBtn" data-id="${user._id}">Reject</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('pendingRequestsTable').innerHTML = html;

      document.querySelectorAll('.acceptBtn').forEach(btn => {
        btn.onclick = async function() {
          const id = btn.dataset.id;
          await fetch(`/api/admin/users/${id}/status`, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ isApproved: true })
          });
          loadPendingRequests();
        };
      });
      document.querySelectorAll('.rejectBtn').forEach(btn => {
        btn.onclick = async function() {
          const id = btn.dataset.id;
          await fetch(`/api/admin/users/${id}/status`, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ isApproved: false })
          });
          loadPendingRequests();
        };
      });
    }
  </script>
</body>
</html> 